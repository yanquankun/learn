`本文为我个人在搭建MPA、Monorepo、SPA等结构上，使用不同构建工具的一点经验`

## 主流构建工具

`webpack` `rollup` `vite` `gulp` 等

## 场景

1. 类库  
   在构建类库的时候，我更加推荐使用 rollup，它更加专注于对 js 的处理，在类库的构建上更为方便，天然支持 tree shaking，在不同模块（amd、cmd、commonjs、es）的处理上更为方便快捷，通过`manualChunks`配合`external`进行库依赖分离操作，使得构建类库时，更加灵活。但在构建 web 应用上，如 HMR 上，它的表现不尽人意，使用起来比较麻烦，所以更推荐在构建类库的时候使用 rollup

2. web 应用  
   那么 web 应用，又会存在多种结构方式，如`MPA` `SPA` `Monorepo`等

   `MPA` `SPA`
   这里我最为推荐使用 vite，天然支持以 html 作为入口，是构建`MPA`不二之选，编译时机为运行时进行增量编译，速度更快，在 esm 上更为专注，当然，也会缺乏一些兼容性，同时它也存在一些弊端，不支持设置多个 config，所以在构建`Monorepo`结构上，不如 webpack 方便

   `Monorepo`  
   这里需要请出构建工具界的老大哥-`webpack`了，它在构建`Monorepo`结构时，更为方便，对于多`bundle`，可以采用多配置共享`devServer`的方式进行构建，而其每个`bundle`内部，则可采用`MPA`|`SPA`的方式（具体根据自己业务进行判断）。由于它的`webpack-html-plugin`插件的优异变现，使得它在构建的时候，可以精准的识别动态依赖，进行自动替换，同时`splitChunk`进行分包操作使得模块体积得到合理控制，配合`devServer`插件，在实现`HMR`的时候，会得心应手。  
   当然，它也有一些缺点，`webpack`构建时机为编译时，采用全量更新的方式，并且`webpack`较为臃肿，如果让我形容的话，可以用下面的一句话对这三种工具进总结：

#### 如果用编程工具来类比的话，webpack 就像 webstorm 一样，而 vite 则类似 vscode，至于 rollup，我愿称之为 sublime😄~

### 或许你发现少了一个 gulp 的工具描述，那么在这里补充下：

当我们有多对多的场景时，使用 gulp 更合适，它用一句话形容：`gulp只是一个打包工具！`感觉更合适，当然，你觉得这句话不是废话么，但你品，你细品 😋

在面对处理 js 多对多、文件监控的场景时，我更推荐使用 gulp，多对一的场景时，更推荐 webpack、rollup，何为多对多？何为多对一？<br/>
`多对多：`即多文件构建输出多文件结果 <br/>
`多对一：`即多文件构建输出单文件结果 <br/>

---

### 聊点别的

在进行前端项目架构的时候，切忌先 code 后 adaptive，首先架构的点，即从程序按照我们既定的方向进行，按照我们设计的流程进行执行，这是关键点，首先我们需要设计技术方案，在构建工具的选择上，也不要太死板，可以结合多个构建工具的特性进行组合，如使用 rollup+gulp 进行搭配使用。<br/>

在流程较复杂的地方，可以搭配流程图进行梳理，遵循一条标准：先设计后 coding~<br/>

搭建项目骨架的时候，要反思维方式，不是要我们适配使用者，而是要使用者适配我们，这就是为什么要先设计后架构的原因。想下我们平时开发新项目脱离工具后，生成的项目结构都是杂乱无序的，而项目资源也都是没有经过统一管理的，同时在面对`dev`和`prod`环境时，需要做的差异化也是不同的，如果要我们适配使用者，往往会面对很多规范外的问题，导致我们不断进行打补丁式操作。<br/>

如我们在搭建`Monorepo`项目时，我们首先要设计所有`bundle`的`page`规则和`entry`规则，在每个`bundle`内部，是`MPA`还是`SPA`或者两者皆有，那我们需要给出使用者一个特定的`Name`规则用来约束，同时也方便我们管理使用者行为。在针对图片类、样式类、chunks 等资源的处理上，需要提前设计好每个规范。<br/>

最终我们的目标是：做到每个资源都在我们的掌握之中。<br/>

在经过`build`后所有的`output`都是我们设计好的，程序也会随我们的预期运行下去。当然，架构需要考虑的东西很多，包括异常监控、项目稳定性、性能监控等，此处不做讨论。
